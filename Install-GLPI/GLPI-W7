# ===========================
# **** Instalação do GLPI ****
# ===========================
$Path = "C:\Program Files\GLPI-Agent\glpi-agent"
$GLPIUrl_GitHub = "https://github.com/glpi-project/glpi-agent/releases/download/1.15/GLPI-Agent-1.15-x64.msi"
$GLPIUrl_Mirror = "\\servidor\instaladores\GLPI-Agent-1.15-x64.msi"   # <- altere para seu mirror interno
$GLPIFile = "$env:TEMP\glpi-agent.msi"

# Detectar Sistema Operacional (compatível PS2.0)
try {
    $OS = (Get-WmiObject Win32_OperatingSystem).Caption
} catch {
    $OS = "Desconhecido"
}
Write-Host "Detectado: $OS" -ForegroundColor Cyan

# --- Função de download ---
function Download-File {
    param([string]$url, [string]$output, [string]$os)

    if ($os -like "*Windows 7*") {
        Write-Host "Windows 7 detectado: tentando mirror interno..." -ForegroundColor Yellow
        
        if (Test-Path $GLPIUrl_Mirror) {
            Copy-Item $GLPIUrl_Mirror -Destination $output -Force
            Write-Host "Instalador copiado do mirror interno." -ForegroundColor Green
        } else {
            Write-Host "Mirror interno não encontrado. Tentando Bitsadmin no GitHub..." -ForegroundColor Yellow
            Start-Process bitsadmin.exe -ArgumentList "/transfer `"DownloadGLPI`" $GLPIUrl_GitHub $output" -Wait
        }
    } else {
        Write-Host "Windows 10/11 detectado: baixando do GitHub com TLS1.2..." -ForegroundColor Green
        try { [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 } catch {}
        if (Get-Command Invoke-WebRequest -ErrorAction SilentlyContinue) {
            Invoke-WebRequest -Uri $GLPIUrl_GitHub -OutFile $output -UseBasicParsing
        } else {
            $wc = New-Object System.Net.WebClient
            $wc.DownloadFile($GLPIUrl_GitHub, $output)
        }
    }
}

# --- Instalação ---
if (!(Test-Path -Path $Path)) {
    try {
        Write-Host "Baixando instalador do GLPI..." -ForegroundColor Yellow
        Download-File -url $GLPIUrl_GitHub -output $GLPIFile -os $OS

        Write-Host "Iniciando instalação..." -ForegroundColor Yellow
        $arguments = @(
            "/i `"$GLPIFile`"",
            "DELAYTIME=120",
            "HTTPD_TRUST=127.0.0.1",
            "NO_SSL_CHECK=1",
            "SCAN_HOMEDIRS=0",
            "SCAN_PROFILES=0",
            "SERVER=http://192.168.0.1/marketplace/glpiinventory/",
            "TAG=$env:COMPUTERNAME",
            "RUNNOW=1",
            "/qn",
            "/norestart"
        )

        $process = Start-Process msiexec.exe -ArgumentList $arguments -Wait -PassThru
        $exitCode = $process.ExitCode

        if ($exitCode -eq 0) {
            Write-Host "Instalação teve sucesso." -ForegroundColor Green
            exit 0
        } else {
            Write-Host "A instalação falhou. Código do erro: $exitCode" -ForegroundColor Red
            exit $exitCode
        }
    } catch {
        Write-Host "Erro durante a instalação via MSI: $($_.Exception.Message)" -ForegroundColor Red
        exit 1
    } finally {
        Remove-Item -Path $GLPIFile -ErrorAction SilentlyContinue
    }
} elseif (Test-Path -Path $Path) {
    Write-Host "Agent GLPI já está instalado" -ForegroundColor Green
    exit 0
} else {
    Write-Host "Agent GLPI não está instalado." -ForegroundColor Red
    exit 1
}
